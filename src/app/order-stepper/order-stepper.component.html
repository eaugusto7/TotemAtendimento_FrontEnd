<mat-horizontal-stepper [linear]="true" #stepper>
  <!-- STEP 1 -->
  <mat-step [stepControl]="productForm">
    <form [formGroup]="productForm">
      <ng-template matStepLabel>Escolher Produto</ng-template>
      <div class="section">
        <h2 class="section-title">Cardápio</h2>
        <div class="menu-list">
          <div class="menu-item"
               *ngFor="let p of products; trackBy: productTrackBy"
               (click)="selectProduct(p)"
               [class.selected]="isProductSelected(p)">
            <img class="menu-img" [src]="p.imageUrl" [alt]="p.name" />
            <div class="menu-info">
              <div class="menu-title">{{ p.name }}</div>
              <div class="menu-desc">{{ p.description }}</div>
              <div class="menu-footer">
                <div class="menu-price">{{ p.price | currency:'BRL' }}</div>
                <button mat-stroked-button color="primary" type="button">Selecionar</button>
              </div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button mat-raised-button color="primary" (click)="stepper.next()" [disabled]="!productForm.valid">
            Continuar
          </button>
        </div>
      </div>
    </form>
  </mat-step>

  <!-- STEP 2 -->
  <mat-step [stepControl]="addonForm">
    <form [formGroup]="addonForm">
      <ng-template matStepLabel>Adicionar Extras</ng-template>
      <div class="section">
        <h2 class="section-title">Adicionais</h2>
        <div class="addons-list">
          <div class="addon-item"
               *ngFor="let a of addons; trackBy: addonTrackBy"
               (click)="toggleAddon(a)"
               [class.selected]="isAddonSelected(a)">
            <img class="addon-img" [src]="a.imageUrl" [alt]="a.name" />
            <div class="addon-info">
              <div class="addon-title">{{ a.name }}</div>
              <div class="addon-desc">{{ a.description || '' }}</div>
              <div class="addon-price">{{ a.price | currency:'BRL' }}</div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button mat-stroked-button color="primary" (click)="stepper.previous()">Voltar</button>
          <button mat-raised-button color="primary" (click)="stepper.next()">Continuar</button>
        </div>
      </div>
    </form>
  </mat-step>

  <!-- STEP 3 -->
  <mat-step>
    <ng-template matStepLabel>Revisar Sacola</ng-template>
    <div class="section">
      <h2 class="section-title">Revisar Sacola</h2>
      <div class="review-card">
        <p><strong>Produto:</strong> {{ orderService.getOrder().product?.name }}</p>
        <div *ngIf="orderService.getOrder().addons?.length">
          <p><strong>Adicionais:</strong></p>
          <ul class="review-addons">
            <li *ngFor="let ad of orderService.getOrder().addons">
              <span class="name">{{ ad.name }}</span>
              <span class="desc" *ngIf="ad.description"> – {{ ad.description }}</span>
              <span class="price">{{ ad.price | currency:'BRL' }}</span>
            </li>
          </ul>
        </div>
        <div class="review-total">Total: <strong>{{ total | currency:'BRL' }}</strong></div>
      </div>
      <div class="actions">
        <button mat-stroked-button color="primary" (click)="stepper.previous()">Voltar</button>
        <button mat-raised-button color="primary" (click)="stepper.next()">Ir para Pagamento</button>
      </div>
    </div>
  </mat-step>

  <!-- STEP 4 -->
  <mat-step>
    <ng-template matStepLabel>Pagamento</ng-template>
    <div class="section">
      <h2 class="section-title">Pagamento</h2>

      <div class="total-pill">Total: <strong>{{ total | currency:'BRL' }}</strong></div>

      <!-- Método -->
      <div class="pay-methods">
        <button mat-stroked-button [color]="paymentForm.value.method==='PIX' ? 'primary' : ''"
                (click)="setMethod('PIX')">Pix</button>
        <button mat-stroked-button [color]="paymentForm.value.method==='CREDIT_CARD' ? 'primary' : ''"
                (click)="setMethod('CREDIT_CARD')">Crédito</button>
        <button mat-stroked-button [color]="paymentForm.value.method==='DEBIT_CARD' ? 'primary' : ''"
                (click)="setMethod('DEBIT_CARD')">Débito</button>
      </div>

      <!-- PIX -->
      <div *ngIf="paymentForm.value.method==='PIX'" class="field-row pix" [formGroup]="paymentForm">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Nome do Comprador</mat-label>
          <input matInput formControlName="buyer_name" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>CPF</mat-label>
          <input matInput formControlName="buyer_cpf" inputmode="numeric" />
        </mat-form-field>

        <div class="actions">
          <button mat-stroked-button color="primary" type="button" (click)="stepper.previous()">Voltar</button>
          <button mat-raised-button color="primary" type="button" (click)="onPayPix()" [disabled]="isPaying">
            {{ isPaying ? 'Processando...' : 'Pagar com Pix' }}
          </button>
        </div>

        <!-- Resultado do PIX: QR e copia-e-cola -->
        <div class="pix-result" *ngIf="pixQrDataUrl || pixCode">
          <div class="pix-qr" *ngIf="pixQrDataUrl">
            <img [src]="pixQrDataUrl" alt="QR Code PIX" />
          </div>
          <div class="pix-code" *ngIf="pixCode">
            <label>Código copia-e-cola:</label>
            <textarea readonly>{{ pixCode }}</textarea>
            <button mat-stroked-button color="primary" type="button" (click)="copyPixCode()">Copiar</button>
          </div>
        </div>
      </div>

      <!-- Cartão -->
      <form *ngIf="paymentForm.value.method==='CREDIT_CARD' || paymentForm.value.method==='DEBIT_CARD'"
            [formGroup]="paymentForm" class="card-form">

        <mat-form-field appearance="outline" class="full">
          <mat-label>Número do Cartão</mat-label>
          <input matInput formControlName="card_number" inputmode="numeric" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Nome no Cartão</mat-label>
          <input matInput formControlName="card_holder" />
        </mat-form-field>

        <div class="row3">
          <mat-form-field appearance="outline">
            <mat-label>Mês</mat-label>
            <input matInput formControlName="expiry_month" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ano</mat-label>
            <input matInput formControlName="expiry_year" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>CVV</mat-label>
            <input matInput formControlName="cvv" />
          </mat-form-field>
        </div>

        <div class="brand-select">
          <button type="button" class="brand-btn"
                  *ngFor="let b of brands"
                  (click)="selectBrand(b.key)"
                  [class.selected]="paymentForm.get('brand')?.value === b.key"
                  [attr.aria-pressed]="paymentForm.get('brand')?.value === b.key">
            <img [src]="b.img" [alt]="b.label" />
            <span class="sr-only">{{ b.label }}</span>
          </button>
        </div>
        <input type="hidden" formControlName="brand" />

        <div class="actions">
          <button mat-stroked-button color="primary" type="button" (click)="stepper.previous()">Voltar</button>
          <button mat-raised-button color="primary" type="button" (click)="onPayCard()" [disabled]="!paymentForm.valid || isPaying">
            {{ isPaying ? 'Processando...' : 'Pagar' }}
          </button>
        </div>
      </form>
    </div>
  </mat-step>
</mat-horizontal-stepper>
